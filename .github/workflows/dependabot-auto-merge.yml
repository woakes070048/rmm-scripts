name: Dependabot Auto-Merge

on: pull_request_target

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Wait for checks and merge
        run: |
          echo "Waiting for checks on ${{ github.event.pull_request.head.sha }}"

          for i in {1..30}; do
            sleep 20

            # Get all checks except this workflow
            CHECKS=$(gh api "repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/check-runs" \
              --jq '[.check_runs[] | select(.name != "auto-merge") | {name: .name, status: .status, conclusion: .conclusion}]')

            TOTAL=$(echo "$CHECKS" | jq 'length')
            PENDING=$(echo "$CHECKS" | jq '[.[] | select(.status != "completed")] | length')
            FAILED=$(echo "$CHECKS" | jq '[.[] | select(.conclusion == "failure" or .conclusion == "cancelled")] | length')

            echo "Attempt $i: $((TOTAL - PENDING))/$TOTAL complete, $FAILED failed"

            # Abort if any check failed
            if [ "$FAILED" -gt 0 ]; then
              echo "::error::CI checks failed"
              exit 1
            fi

            # Merge when all checks pass
            if [ "$PENDING" -eq 0 ] && [ "$TOTAL" -gt 0 ]; then
              echo "All checks passed, merging..."
              gh pr merge --squash "${{ github.event.pull_request.html_url }}"
              exit 0
            fi
          done

          echo "::error::Timeout waiting for checks"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
